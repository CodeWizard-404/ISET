{"version":3,"file":"WSSecurityCert.js","names":["NodeRsa","require","SignedXml","uuid","Security","xmlHandler","crypto","addMinutes","date","minutes","Date","getTime","dateStringForSOAP","getUTCFullYear","getUTCMonth","slice","getUTCDate","getUTCHours","getUTCMinutes","getUTCSeconds","generateCreated","generateExpires","generateId","v4","replace","WSSecurityCert","constructor","privatePEM","publicP12PEM","password","toString","signer","signingKey","getSigningKey","x509Id","references","addReference","_this","keyInfoProvider","getKeyInfo","key","xml","createPrivateKey","privateKey","passphrase","export","type","format","Error","exportKey","postProcess","headerElement","bodyElement","created","expires","binaryToken","id","secElement","element","attribute","text","tsElement","xmlWithSec","doc","end","pretty","computeSignature","sig","getSignatureXml","parseXml","module","exports"],"sources":["../../src/security/WSSecurityCert.js"],"sourcesContent":["// Copyright IBM Corp. 2016,2018. All Rights Reserved.\n// Node module: strong-soap\n// This file is licensed under the MIT License.\n// License text available at https://opensource.org/licenses/MIT\n\n'use strict';\n\nvar NodeRsa = require('node-rsa');\nvar SignedXml = require('xml-crypto').SignedXml;\nvar uuid = require('uuid');\nvar Security = require('./security');\nvar xmlHandler = require('../parser/xmlHandler');\n\nvar crypto = require('crypto');\n\nfunction addMinutes(date, minutes) {\n  return new Date(date.getTime() + minutes * 60000);\n}\n\nfunction dateStringForSOAP(date) {\n  return date.getUTCFullYear() + '-' +\n    ('0' + (date.getUTCMonth() + 1)).slice(-2) + '-' +\n    ('0' + date.getUTCDate()).slice(-2) + 'T' +\n    ('0' + date.getUTCHours()).slice(-2) + \":\" +\n    ('0' + date.getUTCMinutes()).slice(-2) + \":\" +\n    ('0' + date.getUTCSeconds()).slice(-2) + \"Z\";\n}\n\nfunction generateCreated() {\n  return dateStringForSOAP(new Date());\n}\n\nfunction generateExpires() {\n  return dateStringForSOAP(addMinutes(new Date(), 10));\n}\n\nfunction generateId() {\n  return uuid.v4().replace(/-/gm, '');\n}\n\nclass WSSecurityCert extends Security {\n  constructor(privatePEM, publicP12PEM, password) {\n    super();\n    \n    this.publicP12PEM = publicP12PEM.toString()\n      .replace('-----BEGIN CERTIFICATE-----', '')\n      .replace('-----END CERTIFICATE-----', '')\n      .replace(/(\\r\\n|\\n|\\r)/gm, '');\n\n    this.signer = new SignedXml();\n    this.signer.signingKey = this.getSigningKey(privatePEM, password);\n    this.x509Id = 'x509-' + generateId();\n\n    var references = ['http://www.w3.org/2000/09/xmldsig#enveloped-signature',\n      'http://www.w3.org/2001/10/xml-exc-c14n#'];\n\n    this.signer.addReference('//*[local-name(.)=\\'Body\\']', references);\n    this.signer.addReference('//*[local-name(.)=\\'Timestamp\\']', references);\n\n    var _this = this;\n    this.signer.keyInfoProvider = {};\n    this.signer.keyInfoProvider.getKeyInfo = function(key) {\n      var x509Id = _this.x509Id;\n      var xml =\n        `<wsse:SecurityTokenReference>\n    <wsse:Reference URI=\"${x509Id}\" ValueType=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-x509-token-profile-1.0#X509v3\"/>\n    </wsse:SecurityTokenReference>`;\n      return xml;\n    };\n  }\n\n  getSigningKey(privatePEM, password) {\n    if (typeof crypto.createPrivateKey === 'function') {\n      // Node 11 or above\n      this.privateKey = crypto.createPrivateKey({key: privatePEM, passphrase: password});\n      return this.privateKey.export({type: 'pkcs1', format: 'pem'});\n    } else {\n      // Node 10 or below, fall back to https://github.com/rzcoder/node-rsa\n      if (password) throw new Error('Passphrase is not supported by node-rsa.');\n      this.privateKey = new NodeRsa(privatePEM);\n      return this.privateKey.exportKey('private');\n    }\n  }\n\n  postProcess(headerElement, bodyElement) {\n    this.created = generateCreated();\n    this.expires = generateExpires();\n\n    var binaryToken = this.publicP12PEM,\n      created = this.created,\n      expires = this.expires,\n      id = this.x509Id;\n\n    var secElement = headerElement.element('wsse:Security')\n      .attribute('xmlns:wsse', 'http://docs.oasis-open.org/wss/2004/01/' +\n        'oasis-200401-wss-wssecurity-secext-1.0.xsd')\n      .attribute('xmlns:wsu', 'http://docs.oasis-open.org/wss/2004/01/' +\n        'oasis-200401-wss-wssecurity-utility-1.0.xsd')\n      .attribute('soap:mustUnderstand', '1');\n    secElement.element('wsse:BinarySecurityToken')\n      .attribute('EncodingType', 'http://docs.oasis-open.org/wss/2004/01/' +\n        'oasis-200401-wss-soap-message-security-1.0#Base64Binary')\n      .attribute('ValueType', 'http://docs.oasis-open.org/wss/2004/01/' +\n        'oasis-200401-wss-x509-token-profile-1.0#X509v3')\n      .attribute('wsu:Id', id)\n      .text(binaryToken);\n    var tsElement = secElement.element('wsu:Timestamp')\n      .attribute('wsu:Id', '_1');\n    tsElement.element('wsu:Created', created);\n    tsElement.element('wsu:Expires', expires);\n\n    var xmlWithSec = headerElement.doc().end({pretty: true});\n\n    this.signer.computeSignature(xmlWithSec);\n    var sig = this.signer.getSignatureXml();\n\n    xmlHandler.parseXml(secElement, sig);\n  }\n}\n\nmodule.exports = WSSecurityCert;\n"],"mappings":"AAAA;AACA;AACA;AACA;;AAEA,YAAY;;AAEZ,IAAIA,OAAO,GAAGC,OAAO,CAAC,UAAU,CAAC;AACjC,IAAIC,SAAS,GAAGD,OAAO,CAAC,YAAY,CAAC,CAACC,SAAS;AAC/C,IAAIC,IAAI,GAAGF,OAAO,CAAC,MAAM,CAAC;AAC1B,IAAIG,QAAQ,GAAGH,OAAO,CAAC,YAAY,CAAC;AACpC,IAAII,UAAU,GAAGJ,OAAO,CAAC,sBAAsB,CAAC;AAEhD,IAAIK,MAAM,GAAGL,OAAO,CAAC,QAAQ,CAAC;AAE9B,SAASM,UAAUA,CAACC,IAAI,EAAEC,OAAO,EAAE;EACjC,OAAO,IAAIC,IAAI,CAACF,IAAI,CAACG,OAAO,CAAC,CAAC,GAAGF,OAAO,GAAG,KAAK,CAAC;AACnD;AAEA,SAASG,iBAAiBA,CAACJ,IAAI,EAAE;EAC/B,OAAOA,IAAI,CAACK,cAAc,CAAC,CAAC,GAAG,GAAG,GAChC,CAAC,GAAG,IAAIL,IAAI,CAACM,WAAW,CAAC,CAAC,GAAG,CAAC,CAAC,EAAEC,KAAK,CAAC,CAAC,CAAC,CAAC,GAAG,GAAG,GAChD,CAAC,GAAG,GAAGP,IAAI,CAACQ,UAAU,CAAC,CAAC,EAAED,KAAK,CAAC,CAAC,CAAC,CAAC,GAAG,GAAG,GACzC,CAAC,GAAG,GAAGP,IAAI,CAACS,WAAW,CAAC,CAAC,EAAEF,KAAK,CAAC,CAAC,CAAC,CAAC,GAAG,GAAG,GAC1C,CAAC,GAAG,GAAGP,IAAI,CAACU,aAAa,CAAC,CAAC,EAAEH,KAAK,CAAC,CAAC,CAAC,CAAC,GAAG,GAAG,GAC5C,CAAC,GAAG,GAAGP,IAAI,CAACW,aAAa,CAAC,CAAC,EAAEJ,KAAK,CAAC,CAAC,CAAC,CAAC,GAAG,GAAG;AAChD;AAEA,SAASK,eAAeA,CAAA,EAAG;EACzB,OAAOR,iBAAiB,CAAC,IAAIF,IAAI,CAAC,CAAC,CAAC;AACtC;AAEA,SAASW,eAAeA,CAAA,EAAG;EACzB,OAAOT,iBAAiB,CAACL,UAAU,CAAC,IAAIG,IAAI,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC;AACtD;AAEA,SAASY,UAAUA,CAAA,EAAG;EACpB,OAAOnB,IAAI,CAACoB,EAAE,CAAC,CAAC,CAACC,OAAO,CAAC,KAAK,EAAE,EAAE,CAAC;AACrC;AAEA,MAAMC,cAAc,SAASrB,QAAQ,CAAC;EACpCsB,WAAWA,CAACC,UAAU,EAAEC,YAAY,EAAEC,QAAQ,EAAE;IAC9C,KAAK,CAAC,CAAC;IAEP,IAAI,CAACD,YAAY,GAAGA,YAAY,CAACE,QAAQ,CAAC,CAAC,CACxCN,OAAO,CAAC,6BAA6B,EAAE,EAAE,CAAC,CAC1CA,OAAO,CAAC,2BAA2B,EAAE,EAAE,CAAC,CACxCA,OAAO,CAAC,gBAAgB,EAAE,EAAE,CAAC;IAEhC,IAAI,CAACO,MAAM,GAAG,IAAI7B,SAAS,CAAC,CAAC;IAC7B,IAAI,CAAC6B,MAAM,CAACC,UAAU,GAAG,IAAI,CAACC,aAAa,CAACN,UAAU,EAAEE,QAAQ,CAAC;IACjE,IAAI,CAACK,MAAM,GAAG,OAAO,GAAGZ,UAAU,CAAC,CAAC;IAEpC,IAAIa,UAAU,GAAG,CAAC,uDAAuD,EACvE,yCAAyC,CAAC;IAE5C,IAAI,CAACJ,MAAM,CAACK,YAAY,CAAC,6BAA6B,EAAED,UAAU,CAAC;IACnE,IAAI,CAACJ,MAAM,CAACK,YAAY,CAAC,kCAAkC,EAAED,UAAU,CAAC;IAExE,IAAIE,KAAK,GAAG,IAAI;IAChB,IAAI,CAACN,MAAM,CAACO,eAAe,GAAG,CAAC,CAAC;IAChC,IAAI,CAACP,MAAM,CAACO,eAAe,CAACC,UAAU,GAAG,UAASC,GAAG,EAAE;MACrD,IAAIN,MAAM,GAAGG,KAAK,CAACH,MAAM;MACzB,IAAIO,GAAG,GACJ;AACT,2BAA2BP,MAAO;AAClC,mCAAmC;MAC7B,OAAOO,GAAG;IACZ,CAAC;EACH;EAEAR,aAAaA,CAACN,UAAU,EAAEE,QAAQ,EAAE;IAClC,IAAI,OAAOvB,MAAM,CAACoC,gBAAgB,KAAK,UAAU,EAAE;MACjD;MACA,IAAI,CAACC,UAAU,GAAGrC,MAAM,CAACoC,gBAAgB,CAAC;QAACF,GAAG,EAAEb,UAAU;QAAEiB,UAAU,EAAEf;MAAQ,CAAC,CAAC;MAClF,OAAO,IAAI,CAACc,UAAU,CAACE,MAAM,CAAC;QAACC,IAAI,EAAE,OAAO;QAAEC,MAAM,EAAE;MAAK,CAAC,CAAC;IAC/D,CAAC,MAAM;MACL;MACA,IAAIlB,QAAQ,EAAE,MAAM,IAAImB,KAAK,CAAC,0CAA0C,CAAC;MACzE,IAAI,CAACL,UAAU,GAAG,IAAI3C,OAAO,CAAC2B,UAAU,CAAC;MACzC,OAAO,IAAI,CAACgB,UAAU,CAACM,SAAS,CAAC,SAAS,CAAC;IAC7C;EACF;EAEAC,WAAWA,CAACC,aAAa,EAAEC,WAAW,EAAE;IACtC,IAAI,CAACC,OAAO,GAAGjC,eAAe,CAAC,CAAC;IAChC,IAAI,CAACkC,OAAO,GAAGjC,eAAe,CAAC,CAAC;IAEhC,IAAIkC,WAAW,GAAG,IAAI,CAAC3B,YAAY;MACjCyB,OAAO,GAAG,IAAI,CAACA,OAAO;MACtBC,OAAO,GAAG,IAAI,CAACA,OAAO;MACtBE,EAAE,GAAG,IAAI,CAACtB,MAAM;IAElB,IAAIuB,UAAU,GAAGN,aAAa,CAACO,OAAO,CAAC,eAAe,CAAC,CACpDC,SAAS,CAAC,YAAY,EAAE,yCAAyC,GAChE,4CAA4C,CAAC,CAC9CA,SAAS,CAAC,WAAW,EAAE,yCAAyC,GAC/D,6CAA6C,CAAC,CAC/CA,SAAS,CAAC,qBAAqB,EAAE,GAAG,CAAC;IACxCF,UAAU,CAACC,OAAO,CAAC,0BAA0B,CAAC,CAC3CC,SAAS,CAAC,cAAc,EAAE,yCAAyC,GAClE,yDAAyD,CAAC,CAC3DA,SAAS,CAAC,WAAW,EAAE,yCAAyC,GAC/D,gDAAgD,CAAC,CAClDA,SAAS,CAAC,QAAQ,EAAEH,EAAE,CAAC,CACvBI,IAAI,CAACL,WAAW,CAAC;IACpB,IAAIM,SAAS,GAAGJ,UAAU,CAACC,OAAO,CAAC,eAAe,CAAC,CAChDC,SAAS,CAAC,QAAQ,EAAE,IAAI,CAAC;IAC5BE,SAAS,CAACH,OAAO,CAAC,aAAa,EAAEL,OAAO,CAAC;IACzCQ,SAAS,CAACH,OAAO,CAAC,aAAa,EAAEJ,OAAO,CAAC;IAEzC,IAAIQ,UAAU,GAAGX,aAAa,CAACY,GAAG,CAAC,CAAC,CAACC,GAAG,CAAC;MAACC,MAAM,EAAE;IAAI,CAAC,CAAC;IAExD,IAAI,CAAClC,MAAM,CAACmC,gBAAgB,CAACJ,UAAU,CAAC;IACxC,IAAIK,GAAG,GAAG,IAAI,CAACpC,MAAM,CAACqC,eAAe,CAAC,CAAC;IAEvC/D,UAAU,CAACgE,QAAQ,CAACZ,UAAU,EAAEU,GAAG,CAAC;EACtC;AACF;AAEAG,MAAM,CAACC,OAAO,GAAG9C,cAAc","ignoreList":[]}