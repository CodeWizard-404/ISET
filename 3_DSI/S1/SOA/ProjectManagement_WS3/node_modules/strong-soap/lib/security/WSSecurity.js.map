{"version":3,"file":"WSSecurity.js","names":["Security","require","crypto","passwordDigest","validPasswordTypes","toXMLDate","WSSecurity","constructor","username","password","options","_username","_password","_passwordType","passwordType","indexOf","_hasTimeStamp","hasTimeStamp","_hasTokenCreated","hasTokenCreated","hasNonce","_hasNonce","actor","_actor","mustUnderstand","_mustUnderstand","addSoapHeaders","headerElement","secElement","element","attribute","now","Date","created","timeStampXml","expires","getTime","tsElement","userNameElement","nonce","nHash","createHash","update","Math","random","digest","text","module","exports"],"sources":["../../src/security/WSSecurity.js"],"sourcesContent":["// Copyright IBM Corp. 2016. All Rights Reserved.\n// Node module: strong-soap\n// This file is licensed under the MIT License.\n// License text available at https://opensource.org/licenses/MIT\n\n\"use strict\";\n\nvar Security = require('./security');\nvar crypto = require('crypto');\nvar passwordDigest = require('../utils').passwordDigest;\nvar validPasswordTypes = ['PasswordDigest', 'PasswordText'];\nvar toXMLDate = require('../utils').toXMLDate;\n\nclass WSSecurity extends Security {\n  constructor(username, password, options) {\n    options = options || {};\n    super(options);\n    this._username = username;\n    this._password = password;\n    //must account for backward compatibility for passwordType String param as \n    // well as object options defaults: passwordType = 'PasswordText', \n    // hasTimeStamp = true   \n    if (typeof options === 'string') {\n      this._passwordType = options ? options : 'PasswordText';\n      options = {};\n    } else {\n      this._passwordType = options.passwordType ? options.passwordType :\n        'PasswordText';\n    }\n\n    if (validPasswordTypes.indexOf(this._passwordType) === -1) {\n      this._passwordType = 'PasswordText';\n    }\n\n    this._hasTimeStamp = options.hasTimeStamp ||\n    typeof options.hasTimeStamp === 'boolean' ? !!options.hasTimeStamp : true;\n    this._hasTokenCreated = options.hasTokenCreated ||\n    typeof options.hasTokenCreated === 'boolean' ?\n      !!options.hasTokenCreated : true;\n\n    /*jshint eqnull:true */\n    if (options.hasNonce != null) {\n      this._hasNonce = !!options.hasNonce;\n    }\n    this._hasTokenCreated = options.hasTokenCreated ||\n    typeof options.hasTokenCreated === 'boolean' ?\n      !!options.hasTokenCreated : true;\n    if (options.actor != null) {\n      this._actor = options.actor;\n    }\n    if (options.mustUnderstand != null) {\n      this._mustUnderstand = !!options.mustUnderstand;\n    }\n  }\n\n  addSoapHeaders(headerElement) {\n    var secElement = headerElement.element('wsse:Security');\n    if (this._actor) {\n      secElement.attribute('soap:actor', this._actor);\n    }\n    if (this._mustUnderstand) {\n      secElement.attribute('soap:mustUnderstand', '1');\n    }\n\n    secElement\n      .attribute('xmlns:wsse', 'http://docs.oasis-open.org/wss/2004/01/' +\n        'oasis-200401-wss-wssecurity-secext-1.0.xsd')\n      .attribute('xmlns:wsu', 'http://docs.oasis-open.org/wss/2004/01/' +\n        'oasis-200401-wss-wssecurity-utility-1.0.xsd');\n\n    var now = new Date();\n    var created = toXMLDate(now);\n    var timeStampXml = '';\n    if (this._hasTimeStamp) {\n      var expires = toXMLDate(new Date(now.getTime() + (1000 * 600)));\n\n      var tsElement = secElement.element('wsu:Timestamp')\n        .attribute('wsu:Id', 'Timestamp-' + created);\n      tsElement.element('wsu:Created', created);\n      tsElement.element('wsu:Expires', expires);\n    }\n\n    var userNameElement = secElement.element('wsse:UsernameToken')\n      .attribute('wsu:Id', 'SecurityToken-' + created);\n\n    userNameElement.element('wsse:Username', this._username);\n    if (this._hasTokenCreated) {\n      userNameElement.element('wsu:Created', created);\n    }\n\n    var nonce;\n    if(this._hasNonce || this._passwordType !== 'PasswordText') {\n      // nonce = base64 ( sha1 ( created + random ) )\n      var nHash = crypto.createHash('sha1');\n      nHash.update(created + Math.random());\n      nonce = nHash.digest('base64');\n    }\n\n    var password;\n    if (this._passwordType === 'PasswordText') {\n      userNameElement.element('wsse:Password')\n        .attribute('Type', 'http://docs.oasis-open.org/wss/2004/01/' +\n        'oasis-200401-wss-username-token-profile-1.0#PasswordText')\n        .text(this._password);\n\n      if (nonce) {\n        userNameElement.element('wsse:Nonce')\n          .attribute('EncodingType', 'http://docs.oasis-open.org/wss/2004/01/' +\n            'oasis-200401-wss-soap-message-security-1.0#Base64Binary')\n          .text(nonce);\n      }\n    } else {\n      userNameElement.element('wsse:Password')\n        .attribute('Type', 'http://docs.oasis-open.org/wss/2004/01/' +\n          'oasis-200401-wss-username-token-profile-1.0#PasswordDigest')\n        .text(passwordDigest(nonce, created, this._password));\n\n      userNameElement.element('wsse:Nonce')\n        .attribute('EncodingType', 'http://docs.oasis-open.org/wss/2004/01/' +\n          'oasis-200401-wss-soap-message-security-1.0#Base64Binary')\n        .text(nonce);\n    }\n\n  }\n}\n\nmodule.exports = WSSecurity;\n"],"mappings":"AAAA;AACA;AACA;AACA;;AAEA,YAAY;;AAEZ,IAAIA,QAAQ,GAAGC,OAAO,CAAC,YAAY,CAAC;AACpC,IAAIC,MAAM,GAAGD,OAAO,CAAC,QAAQ,CAAC;AAC9B,IAAIE,cAAc,GAAGF,OAAO,CAAC,UAAU,CAAC,CAACE,cAAc;AACvD,IAAIC,kBAAkB,GAAG,CAAC,gBAAgB,EAAE,cAAc,CAAC;AAC3D,IAAIC,SAAS,GAAGJ,OAAO,CAAC,UAAU,CAAC,CAACI,SAAS;AAE7C,MAAMC,UAAU,SAASN,QAAQ,CAAC;EAChCO,WAAWA,CAACC,QAAQ,EAAEC,QAAQ,EAAEC,OAAO,EAAE;IACvCA,OAAO,GAAGA,OAAO,IAAI,CAAC,CAAC;IACvB,KAAK,CAACA,OAAO,CAAC;IACd,IAAI,CAACC,SAAS,GAAGH,QAAQ;IACzB,IAAI,CAACI,SAAS,GAAGH,QAAQ;IACzB;IACA;IACA;IACA,IAAI,OAAOC,OAAO,KAAK,QAAQ,EAAE;MAC/B,IAAI,CAACG,aAAa,GAAGH,OAAO,GAAGA,OAAO,GAAG,cAAc;MACvDA,OAAO,GAAG,CAAC,CAAC;IACd,CAAC,MAAM;MACL,IAAI,CAACG,aAAa,GAAGH,OAAO,CAACI,YAAY,GAAGJ,OAAO,CAACI,YAAY,GAC9D,cAAc;IAClB;IAEA,IAAIV,kBAAkB,CAACW,OAAO,CAAC,IAAI,CAACF,aAAa,CAAC,KAAK,CAAC,CAAC,EAAE;MACzD,IAAI,CAACA,aAAa,GAAG,cAAc;IACrC;IAEA,IAAI,CAACG,aAAa,GAAGN,OAAO,CAACO,YAAY,IACzC,OAAOP,OAAO,CAACO,YAAY,KAAK,SAAS,GAAG,CAAC,CAACP,OAAO,CAACO,YAAY,GAAG,IAAI;IACzE,IAAI,CAACC,gBAAgB,GAAGR,OAAO,CAACS,eAAe,IAC/C,OAAOT,OAAO,CAACS,eAAe,KAAK,SAAS,GAC1C,CAAC,CAACT,OAAO,CAACS,eAAe,GAAG,IAAI;;IAElC;IACA,IAAIT,OAAO,CAACU,QAAQ,IAAI,IAAI,EAAE;MAC5B,IAAI,CAACC,SAAS,GAAG,CAAC,CAACX,OAAO,CAACU,QAAQ;IACrC;IACA,IAAI,CAACF,gBAAgB,GAAGR,OAAO,CAACS,eAAe,IAC/C,OAAOT,OAAO,CAACS,eAAe,KAAK,SAAS,GAC1C,CAAC,CAACT,OAAO,CAACS,eAAe,GAAG,IAAI;IAClC,IAAIT,OAAO,CAACY,KAAK,IAAI,IAAI,EAAE;MACzB,IAAI,CAACC,MAAM,GAAGb,OAAO,CAACY,KAAK;IAC7B;IACA,IAAIZ,OAAO,CAACc,cAAc,IAAI,IAAI,EAAE;MAClC,IAAI,CAACC,eAAe,GAAG,CAAC,CAACf,OAAO,CAACc,cAAc;IACjD;EACF;EAEAE,cAAcA,CAACC,aAAa,EAAE;IAC5B,IAAIC,UAAU,GAAGD,aAAa,CAACE,OAAO,CAAC,eAAe,CAAC;IACvD,IAAI,IAAI,CAACN,MAAM,EAAE;MACfK,UAAU,CAACE,SAAS,CAAC,YAAY,EAAE,IAAI,CAACP,MAAM,CAAC;IACjD;IACA,IAAI,IAAI,CAACE,eAAe,EAAE;MACxBG,UAAU,CAACE,SAAS,CAAC,qBAAqB,EAAE,GAAG,CAAC;IAClD;IAEAF,UAAU,CACPE,SAAS,CAAC,YAAY,EAAE,yCAAyC,GAChE,4CAA4C,CAAC,CAC9CA,SAAS,CAAC,WAAW,EAAE,yCAAyC,GAC/D,6CAA6C,CAAC;IAElD,IAAIC,GAAG,GAAG,IAAIC,IAAI,CAAC,CAAC;IACpB,IAAIC,OAAO,GAAG5B,SAAS,CAAC0B,GAAG,CAAC;IAC5B,IAAIG,YAAY,GAAG,EAAE;IACrB,IAAI,IAAI,CAAClB,aAAa,EAAE;MACtB,IAAImB,OAAO,GAAG9B,SAAS,CAAC,IAAI2B,IAAI,CAACD,GAAG,CAACK,OAAO,CAAC,CAAC,GAAI,IAAI,GAAG,GAAI,CAAC,CAAC;MAE/D,IAAIC,SAAS,GAAGT,UAAU,CAACC,OAAO,CAAC,eAAe,CAAC,CAChDC,SAAS,CAAC,QAAQ,EAAE,YAAY,GAAGG,OAAO,CAAC;MAC9CI,SAAS,CAACR,OAAO,CAAC,aAAa,EAAEI,OAAO,CAAC;MACzCI,SAAS,CAACR,OAAO,CAAC,aAAa,EAAEM,OAAO,CAAC;IAC3C;IAEA,IAAIG,eAAe,GAAGV,UAAU,CAACC,OAAO,CAAC,oBAAoB,CAAC,CAC3DC,SAAS,CAAC,QAAQ,EAAE,gBAAgB,GAAGG,OAAO,CAAC;IAElDK,eAAe,CAACT,OAAO,CAAC,eAAe,EAAE,IAAI,CAAClB,SAAS,CAAC;IACxD,IAAI,IAAI,CAACO,gBAAgB,EAAE;MACzBoB,eAAe,CAACT,OAAO,CAAC,aAAa,EAAEI,OAAO,CAAC;IACjD;IAEA,IAAIM,KAAK;IACT,IAAG,IAAI,CAAClB,SAAS,IAAI,IAAI,CAACR,aAAa,KAAK,cAAc,EAAE;MAC1D;MACA,IAAI2B,KAAK,GAAGtC,MAAM,CAACuC,UAAU,CAAC,MAAM,CAAC;MACrCD,KAAK,CAACE,MAAM,CAACT,OAAO,GAAGU,IAAI,CAACC,MAAM,CAAC,CAAC,CAAC;MACrCL,KAAK,GAAGC,KAAK,CAACK,MAAM,CAAC,QAAQ,CAAC;IAChC;IAEA,IAAIpC,QAAQ;IACZ,IAAI,IAAI,CAACI,aAAa,KAAK,cAAc,EAAE;MACzCyB,eAAe,CAACT,OAAO,CAAC,eAAe,CAAC,CACrCC,SAAS,CAAC,MAAM,EAAE,yCAAyC,GAC5D,0DAA0D,CAAC,CAC1DgB,IAAI,CAAC,IAAI,CAAClC,SAAS,CAAC;MAEvB,IAAI2B,KAAK,EAAE;QACTD,eAAe,CAACT,OAAO,CAAC,YAAY,CAAC,CAClCC,SAAS,CAAC,cAAc,EAAE,yCAAyC,GAClE,yDAAyD,CAAC,CAC3DgB,IAAI,CAACP,KAAK,CAAC;MAChB;IACF,CAAC,MAAM;MACLD,eAAe,CAACT,OAAO,CAAC,eAAe,CAAC,CACrCC,SAAS,CAAC,MAAM,EAAE,yCAAyC,GAC1D,4DAA4D,CAAC,CAC9DgB,IAAI,CAAC3C,cAAc,CAACoC,KAAK,EAAEN,OAAO,EAAE,IAAI,CAACrB,SAAS,CAAC,CAAC;MAEvD0B,eAAe,CAACT,OAAO,CAAC,YAAY,CAAC,CAClCC,SAAS,CAAC,cAAc,EAAE,yCAAyC,GAClE,yDAAyD,CAAC,CAC3DgB,IAAI,CAACP,KAAK,CAAC;IAChB;EAEF;AACF;AAEAQ,MAAM,CAACC,OAAO,GAAG1C,UAAU","ignoreList":[]}