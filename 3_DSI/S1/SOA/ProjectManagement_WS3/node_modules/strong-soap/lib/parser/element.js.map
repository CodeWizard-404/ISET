{"version":3,"file":"element.js","names":["g","require","assert","QName","typeRegistry","helper","xsd","debug","EMPTY_PREFIX","namespaces","Element","constructor","nsName","attrs","options","qname","parse","prefix","name","nsURI","parent","children","xmlns","elementName","_initializeOptions","key","match","exec","xsd_rc","xsi_rc","xsi","valueKey","$targetNamespace","targetNamespace","xmlKey","ignoredNamespaces","forceSoapVersion","startElement","stack","allowedChildren","child","length","_qnameFor","ElementType","getElementType","indexOf","getTargetNamespace","push","unexpected","endElement","extend","addChild","pop","getNamespaceURI","Error","f","describe","definitions","$name","xml","getQName","resolveSchemaObject","schemas","elementType","getBuiltinType","schema","found","elements","complexTypes","simpleTypes","groups","attributes","attributeGroups","postProcess","module","exports"],"sources":["../../src/parser/element.js"],"sourcesContent":["// Copyright IBM Corp. 2016,2017. All Rights Reserved.\n// Node module: strong-soap\n// This file is licensed under the MIT License.\n// License text available at https://opensource.org/licenses/MIT\n\n'use strict';\n\nvar g = require('../globalize');\nvar assert = require('assert');\nvar QName = require('./qname');\nvar typeRegistry = require('./typeRegistry');\nvar helper = require('./helper');\nvar xsd = require('./xsd');\nvar debug = require('debug')('strong-soap:wsdl:element');\n\nvar EMPTY_PREFIX = helper.EMPTY_PREFIX;\nvar namespaces = helper.namespaces;\n\n/**\n * Base class for all elements of WSDL/XSD\n */\nclass Element {\n  constructor(nsName, attrs, options) {\n    var qname = QName.parse(nsName);\n\n    this.nsName = nsName;\n    this.prefix = qname.prefix;\n    this.name = qname.name;\n    this.nsURI = '';\n    this.parent = null;\n    this.children = [];\n    this.xmlns = {};\n\n    if (this.constructor.elementName) {\n      assert(this.name === this.constructor.elementName,\n        'Invalid element name: ' + this.name);\n    }\n\n    this._initializeOptions(options);\n\n    for (var key in attrs) {\n      var match = /^xmlns:?(.*)$/.exec(key);\n      if (match) {\n        if (attrs[key] === namespaces.xsd_rc) {\n          // Handle http://www.w3.org/2000/10/XMLSchema\n          attrs[key] = namespaces.xsd;\n        }\n        if (attrs[key] === namespaces.xsi_rc) {\n          // Handle http://www.w3.org/2000/10/XMLSchema-instance\n          attrs[key] = namespaces.xsi;\n        }\n        this.xmlns[match[1] ? match[1] : EMPTY_PREFIX] = attrs[key];\n      }\n      else {\n        if (key === 'value') {\n          this[this.valueKey] = attrs[key];\n        } else {\n          this['$' + key] = attrs[key];\n        }\n      }\n    }\n    if (this.$targetNamespace) {\n      this.targetNamespace = this.$targetNamespace;\n    }\n  }\n\n  _initializeOptions(options) {\n    if (options) {\n      this.valueKey = options.valueKey || '$value';\n      this.xmlKey = options.xmlKey || '$xml';\n      this.ignoredNamespaces = options.ignoredNamespaces || [];\n      this.forceSoapVersion = options.forceSoapVersion;\n    } else {\n      this.valueKey = '$value';\n      this.xmlKey = '$xml';\n      this.ignoredNamespaces = [];\n    }\n  }\n\n  startElement(stack, nsName, attrs, options) {\n    if (!this.constructor.allowedChildren)\n      return;\n\n    var child;\n    var parent = stack[stack.length - 1];\n\n    var qname = this._qnameFor(stack, nsName, attrs, options);\n    var ElementType = typeRegistry.getElementType(qname);\n    if (this.constructor.allowedChildren.indexOf(qname.name) === -1 &&\n      this.constructor.allowedChildren.indexOf('any') === -1) {\n      debug('Element %s is not allowed within %j', qname, this.nsName);\n    }\n    \n    if (ElementType) {\n      child = new ElementType(nsName, attrs, options);\n      child.nsURI = qname.nsURI;\n      child.targetNamespace = attrs.targetNamespace || this.getTargetNamespace();\n      debug('Element created: ', child);\n      child.parent = parent;\n      stack.push(child);\n    } else {\n      this.unexpected(nsName);\n    }\n  }\n\n  endElement(stack, nsName) {\n    if (this.nsName === nsName) {\n      if (stack.length < 2)\n        return;\n      var parent = stack[stack.length - 2];\n      if (this !== stack[0]) {\n        helper.extend(stack[0].xmlns, this.xmlns);\n        parent.children.push(this);\n        parent.addChild(this);\n      }\n      stack.pop();\n    }\n  }\n\n  _qnameFor(stack, nsName, attrs, options) {\n    // Create a dummy element to help resolve the XML namespace\n    var child = new Element(nsName, attrs, options);\n    var parent = stack[stack.length - 1];\n    child.parent = parent;\n\n    var qname = QName.parse(nsName);\n    qname.nsURI = child.getNamespaceURI(qname.prefix);\n    return qname;\n  }\n\n  addChild(child) {\n    return;\n  }\n\n  unexpected(name) {\n    throw new Error(g.f('Found unexpected element (%s) inside %s', name, this.nsName));\n  }\n\n  describe(definitions) {\n    return this.$name || this.name;\n  }\n\n  /**\n   * Look up the namespace by prefix\n   * @param {string} prefix Namespace prefix\n   * @returns {string} Namespace\n   */\n  getNamespaceURI(prefix) {\n    if (prefix === 'xml') return helper.namespaces.xml;\n    var nsURI = null;\n    if (this.xmlns && prefix in this.xmlns) {\n      nsURI = this.xmlns[prefix];\n    } else {\n      if (this.parent) {\n        return this.parent.getNamespaceURI(prefix);\n      }\n    }\n    return nsURI;\n  }\n\n  /**\n   * Get the target namespace URI\n   * @returns {string} Target namespace URI\n   */\n  getTargetNamespace() {\n    if (this.targetNamespace) {\n      return this.targetNamespace;\n    } else if (this.parent) {\n      return this.parent.getTargetNamespace();\n    }\n    return null;\n  }\n\n  /**\n   * Get the qualified name\n   * @returns {QName} Qualified name\n   */\n  getQName() {\n    return new QName(this.targetNamespace, this.$name);\n  }\n\n  /**\n   * Resolve a schema object by qname\n   * @param schemas\n   * @param elementType\n   * @param nsName\n   * @returns {*}\n   */\n  resolveSchemaObject(schemas, elementType, nsName) {\n    var qname = QName.parse(nsName);\n    var nsURI;\n    if (qname.prefix === 'xml') return null;\n    if (qname.prefix) nsURI = this.getNamespaceURI(qname.prefix);\n    else nsURI = this.getTargetNamespace();\n    qname.nsURI = nsURI;\n    var name = qname.name;\n    if (nsURI === helper.namespaces.xsd &&\n      (elementType === 'simpleType' || elementType === 'type')) {\n      return xsd.getBuiltinType(name);\n    }\n    var schema = schemas[nsURI];\n    if (!schema) {\n      debug('Schema not found: %s (%s)', qname, elementType);\n      return null;\n    }\n    var found = null;\n    switch (elementType) {\n      case 'element':\n        found = schema.elements[name];\n        break;\n      case 'type':\n        found = schema.complexTypes[name] || schema.simpleTypes[name];\n        break;\n      case 'simpleType':\n        found = schema.simpleTypes[name];\n        break;\n      case 'complexType':\n        found = schema.complexTypes[name];\n        break;\n      case 'group':\n        found = schema.groups[name];\n        break;\n      case 'attribute':\n        found = schema.attributes[name];\n        break;\n      case 'attributeGroup':\n        found = schema.attributeGroups[name];\n        break;\n    }\n    if (!found) {\n      debug('Schema %s not found: %s %s', elementType, nsURI, nsName);\n      return null;\n    }\n    return found;\n  }\n\n  postProcess(definitions) {\n    debug('Unknown element: %s %s', this.nsURI, this.nsName)\n  }\n}\n\nElement.EMPTY_PREFIX = EMPTY_PREFIX;\nElement.namespaces = namespaces;\n\nmodule.exports = Element;\n"],"mappings":"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","ignoreList":[]}