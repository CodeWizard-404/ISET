{"version":3,"file":"http.js","names":["url","require","requestModule","debug","debugSensitive","httpntlm","uuid","v4","VERSION","version","HttpClient","constructor","options","_request","request","buildRequest","rurl","data","exheaders","exoptions","curl","parse","secure","protocol","host","hostname","port","parseInt","path","pathname","search","hash","join","method","headers","isNaN","attr","header","attachments","mergeOptions","length","Buffer","byteLength","uri","followAllRedirects","start","multipart","forEach","attachment","push","mimetype","contentId","name","body","indexOf","handleResponse","req","res","match","isNtlmAuthRequired","ntlmSecurity","methodName","wsdlAuthRequired","callback","self","NTLMSecurity","ntlmAuth","err","username","password","domain","workstation","ntlm","strict","toLocaleLowerCase","module","exports"],"sources":["../src/http.js"],"sourcesContent":["// Copyright IBM Corp. 2016. All Rights Reserved.\n// Node module: strong-soap\n// This file is licensed under the MIT License.\n// License text available at https://opensource.org/licenses/MIT\n\n'use strict';\n\nvar url = require('url');\nvar requestModule = require('@cypress/request');\nvar debug = require('debug')('strong-soap:http');\nvar debugSensitive = require('debug')('strong-soap:http:sensitive');\nvar httpntlm = require('httpntlm');\nvar uuid = require('uuid').v4;\n\n\nvar VERSION = require('../package.json').version;\n\n/**\n * A class representing the http client\n * @param {Object} [options] Options object. It allows the customization of\n * `request` module\n *\n * @constructor\n */\nclass HttpClient {\n  constructor(options) {\n    this.options = options || {};\n    this._request = options.request || requestModule;\n  }\n\n  /**\n   * Build the HTTP request (method, uri, headers, ...)\n   * @param {String} rurl The resource url\n   * @param {Object|String} data The payload\n   * @param {Object} exheaders Extra http headers\n   * @param {Object} exoptions Extra options\n   * @returns {Object} The http request object for the `request` module\n   */\n  buildRequest(rurl, data, exheaders, exoptions) {\n    var curl = url.parse(rurl);\n    var secure = curl.protocol === 'https:';\n    var host = curl.hostname;\n    var port = parseInt(curl.port, 10);\n    var path = [curl.pathname || '/', curl.search || '', curl.hash || ''].join('');\n    var method = data ? 'POST' : 'GET';\n    var headers = {\n      'User-Agent': 'strong-soap/' + VERSION,\n      'Accept': 'text/html,application/xhtml+xml,application/xml,text/xml;q=0.9,*/*;q=0.8',\n      'Accept-Encoding': 'none',\n      'Accept-Charset': 'utf-8',\n      'Connection': 'close',\n      'Host': host + (isNaN(port) ? '' : ':' + port)\n    };\n    var attr;\n    var header;\n    var attachments = []\n    var mergeOptions = ['headers'];\n    if (exoptions) {\n      attachments = exoptions.attachments || [];\n    }\n\n    if (typeof data === 'string' && attachments.length === 0) {\n      headers['Content-Length'] = Buffer.byteLength(data, 'utf8');\n      headers['Content-Type'] = 'application/x-www-form-urlencoded';\n    }\n\n    exheaders = exheaders || {};\n    for (attr in exheaders) {\n      headers[attr] = exheaders[attr];\n    }\n\n    var options = {\n      uri: curl,\n      method: method,\n      headers: headers,\n      followAllRedirects: true\n    };\n\n    if (attachments.length > 0) {\n      const start = uuid();\n      headers['Content-Type'] =\n        'multipart/related; type=\"application/xop+xml\"; start=\"<' + start + '>\"; start-info=\"text/xml\"; boundary=' + uuid();\n      const multipart = [{\n        'Content-Type': 'application/xop+xml; charset=UTF-8; type=\"text/xml\"',\n        'Content-ID': '<' + start + '>',\n        'body': data,\n      }];\n\n      attachments.forEach((attachment) => {\n        multipart.push({\n          'Content-Type': attachment.mimetype,\n          'Content-Transfer-Encoding': 'binary',\n          'Content-ID': '<' + attachment.contentId + '>',\n          'Content-Disposition': 'attachment; filename=\"' + attachment.name + '\"',\n          'body': attachment.body,\n        });\n      });\n      options.multipart = multipart;\n    } else {\n      options.body = data;\n    }\n\n\n    exoptions = exoptions || {};\n    for (attr in exoptions) {\n      if (mergeOptions.indexOf(attr) !== -1) {\n        for (header in exoptions[attr]) {\n          options[attr][header] = exoptions[attr][header];\n        }\n      } else {\n        options[attr] = exoptions[attr];\n      }\n    }\n    debug('Http request: %j', options);\n    return options;\n  }\n\n  /**\n   * Handle the http response\n   * @param {Object} The req object\n   * @param {Object} res The res object\n   * @param {Object} body The http body\n   * @param {Object} The parsed body\n   */\n  handleResponse(req, res, body) {\n    debug('Http response body: %j', body);\n    if (typeof body === 'string') {\n      // Remove any extra characters that appear before or after the SOAP\n      // envelope.\n      var match = body.match(\n        /(?:<\\?[^?]*\\?>[\\s]*)?<([^:]*):Envelope([\\S\\s]*)<\\/\\1:Envelope>/i);\n      if (match) {\n        body = match[0];\n      }\n    }\n    return body;\n  }\n\n  //check if NTLM authentication needed\n  isNtlmAuthRequired(ntlmSecurity, methodName) {\n    //if ntlmSecurity is not set, then remote web service is not NTLM authenticated Web Service\n    if (ntlmSecurity == null) {\n      return false;\n    } else if (methodName === 'GET' && (ntlmSecurity.wsdlAuthRequired == null || ntlmSecurity.wsdlAuthRequired === false)) {\n      //In some WebServices, getting remote WSDL is not NTLM authenticated. Only WebService invocation is NTLM authenticated.\n      return false;\n    }\n    //need NTLM authentication for both 'GET' (remote wsdl retrieval) and 'POST' (Web Service invocation)\n    return true;\n  }\n\n  request(rurl, data, callback, exheaders, exoptions) {\n    var self = this;\n    var options = self.buildRequest(rurl, data, exheaders, exoptions);\n    var headers = options.headers;\n    var req;\n\n    //typically clint.js would do addOptions() if security is set in order to get all security options added to options{}. But client.js\n    //addOptions() code runs after this code is trying to contact server to load remote WSDL, hence we have NTLM authentication\n    //object passed in as option to createClient() call for now. Revisit.\n    var ntlmSecurity = this.options.NTLMSecurity;\n    var ntlmAuth = self.isNtlmAuthRequired(ntlmSecurity, options.method);\n    if (!ntlmAuth) {\n      req = self._request(options, function (err, res, body) {\n        if (err) {\n          return callback(err);\n        }\n        body = self.handleResponse(req, res, body);\n        callback(null, res, body);\n      });\n    } else {\n        //httpntlm code needs 'url' in options{}. It should be plain string, not parsed uri\n        options.url = rurl;\n        options.username = ntlmSecurity.username;\n        options.password = ntlmSecurity.password;\n        options.domain = ntlmSecurity.domain;\n        options.workstation = ntlmSecurity.workstation;\n        options.request = requestModule;\n        options.ntlm = { strict: true };\n        //httpntlm code uses lower case for method names - 'get', 'post' etc\n        var method = options.method.toLocaleLowerCase();\n        debugSensitive('NTLM options: %j for method: %s', options, method);\n        debug('httpntlm method: %s', method);\n        req = httpntlm['method'](method, options, function (err, res) {\n          if (err) {\n            return callback(err);\n          }\n          var body = self.handleResponse(req, res, res.body);\n          callback(null, res, body);\n        });\n      }\n\n    return req;\n  }\n}\n\nmodule.exports = HttpClient;\n"],"mappings":"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","ignoreList":[]}